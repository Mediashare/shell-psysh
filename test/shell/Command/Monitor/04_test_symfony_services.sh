#!/bin/bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$SCRIPT_DIR/../../lib/func/loader.sh"

# Initialiser l'environnement de test
init_test_environment
init_test "symfony services"

# √âtape 1: Test Container Symfony - V√©rifier qu'il y a au moins 20 services
test_monitor_echo "Container Symfony - Nombre de services (‚â•20)" \
'$services = $container->getServiceIds(); $count = count($services); echo $count = 20 ? "OK: $count services" : "FAIL: only $count services"' \
'OK:.*services'

# √âtape 2: Test Kernel et environnement
test_monitor_expression "Kernel environnement" \
'$kernel->getEnvironment()' \
'dev'

# √âtape 3: Test Router
test_monitor_echo "Router - Collection de routes" \
'$class = get_class($router->getRouteCollection()); echo $class' \
'Symfony\\Component\\Routing\\RouteCollection'

# √âtape 4: Test EventDispatcher - V√©rifier qu'il y a au moins quelques listeners
test_monitor_echo "EventDispatcher - Nombre de listeners (‚â• 3)" \
'$count = count($dispatcher->getListeners()); echo $count >= 3 ? "OK: $count listeners" : "FAIL: only $count listeners"' \
'OK:.*listeners'

# √âtape 5: Test d'erreur - service inexistant
test_monitor_error "Service inexistant" \
'$container->get("nonexistent.service")' \
'non-existent service'

# √âtape 6: Test d'erreur - param√®tre inexistant
test_monitor_error "Param√®tre inexistant" \
'$container->getParameter("nonexistent.parameter")' \
'non-existent parameter'

# √âtape 7: Test sync - services persistants
test_shell_responsiveness "Services persistants" \
'$my_service = $container->get("kernel");' \
'echo get_class($my_service)' \
'App\\Kernel'

# Afficher le r√©sum√©
test_summary

# Nettoyer l'environnement de test
cleanup_test_environment

# Sortir avec le code appropri√©
if [[ $FAIL_COUNT -gt 0 ]]; then
    exit 1
else
    exit 0
fi
