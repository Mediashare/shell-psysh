#!/bin/bash

# Test script for Snapshot commands
# Tests PHPUnitSnapshotCommand, PHPUnitSaveSnapshotCommand

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/../../lib/test_utils.sh"

# Vérifier que PROJECT_ROOT est défini
if [[ -z "$PROJECT_ROOT" ]]; then
    PROJECT_ROOT="$(cd "$(dirname "$0")" && cd ../.. && pwd)"
    export PROJECT_ROOT
fi

init_test "Snapshot Commands"
echo ""

# Test PHPUnitSnapshotCommand (phpunit:snapshot)
run_test_step "phpunit:snapshot help" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:snapshot --help\"" \
    "Usage:" \
    "check_contains"

# Test PHPUnitSaveSnapshotCommand (phpunit:save-snapshot)
run_test_step "phpunit:save-snapshot help" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:save-snapshot --help\"" \
    "Usage:" \
    "check_contains"

# Test snapshot creation with basic data
run_test_step "Create snapshot with basic data" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:save-snapshot --name='test_snapshot' --data='test data'\"" \
    "Snapshot saved" \
    "check_contains"

# Test snapshot listing
run_test_step "List snapshots" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:snapshot --list\"" \
    "snapshots" \
    "check_contains"

# Test snapshot comparison
run_test_step "Compare snapshots" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:snapshot --compare='snapshot1,snapshot2'\"" \
    "comparison" \
    "check_contains"

# Test snapshot with array data
run_test_step "Create snapshot with array data" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:save-snapshot --name='array_snapshot' --data='[1,2,3,4,5]'\"" \
    "Snapshot saved" \
    "check_contains"

# Test snapshot with object data
run_test_step "Create snapshot with object data" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:save-snapshot --name='object_snapshot' --data='new stdClass()'\"" \
    "Snapshot saved" \
    "check_contains"

# Test snapshot restore
run_test_step "Restore snapshot" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:snapshot --restore='test_snapshot'\"" \
    "restored" \
    "check_contains"

# Test snapshot deletion
run_test_step "Delete snapshot" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:snapshot --delete='test_snapshot'\"" \
    "deleted" \
    "check_contains"

# Test combined snapshot operations
run_test_step "Combined snapshot operations" \
    "$PROJECT_ROOT/bin/psysh -c \"phpunit:save-snapshot --name='combined_test' --data='test'; phpunit:snapshot --list\"" \
    "Snapshot saved" \
    "check_contains"

test_summary
