#!/bin/bash

# Test 33: Commande phpunit:assert - Assertions PHPUnit
# Tests d'intégration pour les assertions dans les tests PHPUnit

# Get script directory and project root
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "$SCRIPT_DIR/../../.." && pwd )"

# Source les bibliothèques de test
source "$SCRIPT_DIR/../../lib/func/loader.sh"
# Charger test_session_sync
source "$(dirname "$0")/../../lib/func/test_session_sync_enhanced.sh"

# Initialiser le test
init_test "TEST 33: Commande phpunit:assert"

# Étape 1: Créer un test pour les assertions
test_monitor_multiline "Créer un test pour assertions" \
'phpunit:create AssertionTest' \
'✅ Test créé : AssertionTest'

# Étape 2: Ajouter assertion simple
test_monitor_multiline "Assertion assertTrue simple" \
'phpunit:assert "$this->assertTrue(true)"' \
'✅ Assertion ajoutée : $this->assertTrue(true)'

# Étape 3: Assertion assertEquals
test_monitor_multiline "Assertion assertEquals" \
'phpunit:assert "$this->assertEquals(5, 2 + 3)"' \
'✅ Assertion ajoutée'

# Étape 4: Assertion assertSame
test_monitor_multiline "Assertion assertSame" \
'phpunit:assert "$this->assertSame(\"expected\", \"expected\")"' \
'✅ Assertion ajoutée'

# Étape 5: Assertion assertInstanceOf
test_monitor_multiline "Assertion assertInstanceOf" \
'phpunit:assert "$this->assertInstanceOf(stdClass::class, new stdClass())"' \
'✅ Assertion ajoutée'

# Étape 6: Assertion assertArrayHasKey
test_monitor_multiline "Assertion assertArrayHasKey" \
'phpunit:assert "$this->assertArrayHasKey(\"key\", [\"key\" => \"value\"])"' \
'✅ Assertion ajoutée'

# Étape 7: Assertion assertCount
test_monitor_multiline "Assertion assertCount" \
'phpunit:assert "$this->assertCount(3, [1, 2, 3])"' \
'✅ Assertion ajoutée'

# Étape 8: Assertion assertEmpty
test_monitor_multiline "Assertion assertEmpty" \
'phpunit:assert "$this->assertEmpty([])"' \
'✅ Assertion ajoutée'

# Étape 9: Assertion assertNotEmpty
test_monitor_multiline "Assertion assertNotEmpty" \
'phpunit:assert "$this->assertNotEmpty([1, 2, 3])"' \
'✅ Assertion ajoutée'

# Étape 10: Assertion assertNull
test_monitor_multiline "Assertion assertNull" \
'phpunit:assert "$this->assertNull(null)"' \
'✅ Assertion ajoutée'

# Étape 11: Assertion assertNotNull
test_monitor_multiline "Assertion assertNotNull" \
'phpunit:assert "$this->assertNotNull(\"value\")"' \
'✅ Assertion ajoutée'

# Étape 12: Assertion complexe avec message
test_monitor_multiline "Assertion avec message personnalisé" \
'phpunit:assert "$this->assertTrue($result, \"Custom failure message\")"' \
'✅ Assertion ajoutée'

# Étape 13: Assertion expectException
test_monitor_multiline "Assertion expectException" \
'phpunit:assert "$this->expectException(InvalidArgumentException::class)"' \
'✅ Assertion ajoutée'

# Étape 14: Test sans test actuel (erreur)
test_monitor_multiline "Test sans contexte de test" \
'unset($GLOBALS["phpunit_current_test"])
phpunit:assert "$this->assertTrue(true)"' \
'❌ Aucun test actuel'

# Étape 15: Test avec assertion invalide
test_monitor_error "Assertion syntaxe invalide" \
'phpunit:create ErrorTest
phpunit:assert "invalidSyntax("' \
'❌'

# Étape 16: Multiple assertions dans le même test
test_monitor_multiline "Multiples assertions" \
'phpunit:create MultipleAssertTest
phpunit:assert "$this->assertTrue($condition1)"
phpunit:assert "$this->assertFalse($condition2)"
phpunit:assert "$this->assertEquals(5, $result)"' \
'✅ Assertion ajoutée'

# Étape 17: Assertion avec regex
test_monitor_multiline "Assertion avec regex" \
'phpunit:assert "$this->assertMatchesRegularExpression(\"/[a-z]+/\", \"hello\")"' \
'✅ Assertion ajoutée'

# Étape 18: Assertion JSON
test_monitor_multiline "Assertion JSON" \
'phpunit:assert "$this->assertJson(json_encode([\"key\" => \"value\"]))"' \
'✅ Assertion ajoutée'

# Étape 19: Vérifier l'ordre des assertions dans le code généré
test_monitor_multiline "Vérifier ordre des assertions" \
'phpunit:create OrderTest
phpunit:assert "$this->assertTrue($first)"
phpunit:assert "$this->assertFalse($second)"
phpunit:assert "$this->assertEquals(5, $third)"' \
'✅ Assertion ajoutée'

# Étape 20: Test avec assertion et code mixte
test_monitor_multiline "Mélange assertions et code" \
'phpunit:create MixedTest
phpunit:code --snippet "$user = new stdClass();"
phpunit:assert "$this->assertInstanceOf(stdClass::class, $user)"' \
'✅ Assertion ajoutée'

# Afficher le résumé
test_summary

# Sortir avec le code approprié
if [[ $FAIL_COUNT -gt 0 ]]; then
    exit 1
else
    exit 0
fi
