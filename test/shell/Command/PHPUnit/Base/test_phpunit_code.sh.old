#!/bin/bash

# Test phpunit:code command
# Tests all options and scenarios for interactive code mode

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../../.." && pwd)"
PSYSH_CMD="$PROJECT_ROOT/vendor/bin/psysh --config $PROJECT_ROOT/config/config.php"

echo "üß™ Testing phpunit:code command..."

# Test 1: Basic code mode activation
echo "üìù Test 1: Basic code mode activation"
{
    echo 'phpunit:create TestService'
    echo 'phpunit:code'
    echo 'exit'
} | timeout 15 $PSYSH_CMD --no-interactive > /tmp/psysh_code_1.out 2>&1 || true
if grep -q -E "(Mode code|code activ√©)" /tmp/psysh_code_1.out; then
    echo "‚úÖ Basic code mode activation works"
else
    echo "‚ùå Basic code mode activation failed"
    cat /tmp/psysh_code_1.out
fi

# Test 2: Code mode with variable creation
echo "üìù Test 2: Code mode with variable creation"
{
    echo 'phpunit:create UserService'
    echo 'phpunit:code'
    echo '$user = new stdClass()'
    echo '$user->name = "John"'
    echo 'exit'
} | timeout 15 $PSYSH_CMD --no-interactive > /tmp/psysh_code_2.out 2>&1 || true
if grep -q -E "(Mode code|variables|ajout√©e)" /tmp/psysh_code_2.out; then
    echo "‚úÖ Code mode with variables works"
else
    echo "‚ùå Code mode with variables failed"
    cat /tmp/psysh_code_2.out
fi

# Test 3: Error handling - no test created first
echo "üìù Test 3: Error handling - no test created first"
echo 'phpunit:code' | timeout 10 $PSYSH_CMD --no-interactive > /tmp/psysh_code_3.out 2>&1 || true
if grep -q -E "(Aucun test|test actuel|error)" /tmp/psysh_code_3.out; then
    echo "‚úÖ Error handling works"
else
    echo "‚ùå Error handling failed"
    cat /tmp/psysh_code_3.out
fi

# Test 4: Code mode with method calls
echo "üìù Test 4: Code mode with method calls"
{
    echo 'phpunit:create ServiceTest'
    echo 'phpunit:code'
    echo '$data = ["key" => "value"]'
    echo '$result = array_keys($data)'
    echo 'exit'
} | timeout 15 $PSYSH_CMD --no-interactive > /tmp/psysh_code_4.out 2>&1 || true
if grep -q -E "(Mode code|termin√©)" /tmp/psysh_code_4.out; then
    echo "‚úÖ Code mode with method calls works"
else
    echo "‚ùå Code mode with method calls failed"
    cat /tmp/psysh_code_4.out
fi

# Test 5: Code mode with complex objects
echo "üìù Test 5: Code mode with complex objects"
{
    echo 'phpunit:create ComplexService'
    echo 'phpunit:code'
    echo '$config = new stdClass()'
    echo '$config->debug = true'
    echo '$config->env = "test"'
    echo 'exit'
} | timeout 15 $PSYSH_CMD --no-interactive > /tmp/psysh_code_5.out 2>&1 || true
if grep -q -E "(Mode code|termin√©)" /tmp/psysh_code_5.out; then
    echo "‚úÖ Code mode with complex objects works"
else
    echo "‚ùå Code mode with complex objects failed"
    cat /tmp/psysh_code_5.out
fi

# Clean up
rm -f /tmp/psysh_code_*.out

echo "‚ú® phpunit:code tests completed"
