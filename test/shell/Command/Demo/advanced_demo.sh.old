#!/bin/bash

# =============================================================================
# DÃ‰MONSTRATION AVANCÃ‰E DE L'UNIFIED_TEST_EXECUTOR
# =============================================================================
# Ce script dÃ©montre toutes les capacitÃ©s avancÃ©es de l'architecture modulaire
# pour tester les commandes shell psysh avec flexibilitÃ© maximale

# Obtenir le rÃ©pertoire du script et charger l'exÃ©cuteur unifiÃ©
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$SCRIPT_DIR/../../lib/unified_test_executor.sh"

# Initialiser l'environnement de test
init_test_environment
init_test "DÃ‰MO AVANCÃ‰E - Unified Test Executor"

echo -e "${YELLOW}Cette dÃ©monstration illustre toutes les capacitÃ©s de la nouvelle architecture:${NC}"
echo -e "${CYAN}â€¢ Tests avec diffÃ©rents contextes (monitor, phpunit, shell, mixed)${NC}"
echo -e "${CYAN}â€¢ Types d'input variÃ©s (pipe, file, echo, interactive, multiline)${NC}"
echo -e "${CYAN}â€¢ Types de vÃ©rification (contains, exact, regex, json, error)${NC}"
echo -e "${CYAN}â€¢ Options avancÃ©es (retry, timeout, sync, debug)${NC}"
echo ""

# =============================================================================
# SECTION 1: TESTS MONITOR BASIQUES ET AVANCÃ‰S
# =============================================================================

echo -e "${PURPLE}=== SECTION 1: Tests Monitor ===${NC}"

# Test monitor simple avec echo
test_execute "Monitor simple avec echo" \
'$x = 42; echo $x;' \
"42" \
--context=monitor --input-type=echo

# Test monitor avec input multilignes
test_execute "Monitor multilignes" \
'$a = 10;
$b = 20;
$result = $a + $b;
echo $result;' \
"30" \
--context=monitor --input-type=multiline

# Test monitor avec vÃ©rification regex
test_execute "Monitor avec regex" \
'echo date("Y-m-d");' \
"[0-9]{4}-[0-9]{2}-[0-9]{2}" \
--context=monitor --output-check=regex

# Test monitor avec retry automatique
test_execute "Monitor avec retry" \
'echo "test";' \
"test" \
--context=monitor --retry=3 --timeout=5

# =============================================================================
# SECTION 2: TESTS PHPUNIT AVEC OPTIONS AVANCÃ‰ES
# =============================================================================

echo -e "${PURPLE}=== SECTION 2: Tests PHPUnit avancÃ©s ===${NC}"

# Test phpunit avec crÃ©ation et vÃ©rification
test_execute "PHPUnit create avancÃ©" \
"create DemoTest --description 'Test de dÃ©monstration'" \
"Test crÃ©Ã©" \
--context=phpunit --output-check=contains

# Test phpunit avec assertion complexe
test_execute "PHPUnit assert complexe" \
"assert 'array_sum([1,2,3]) == 6' --message='Array sum test'" \
"âœ…" \
--context=phpunit

# Test phpunit avec vÃ©rification exacte
test_execute "PHPUnit vÃ©rification exacte" \
"assert 'true'" \
"âœ… Assertion rÃ©ussie" \
--context=phpunit --output-check=exact

# =============================================================================
# SECTION 3: TESTS SHELL ET MIXED
# =============================================================================

echo -e "${PURPLE}=== SECTION 3: Tests Shell et Mixed ===${NC}"

# Test shell simple
test_execute "Shell simple" \
"echo 'Hello from shell'" \
"Hello from shell" \
--context=shell

# Test mixed (combinaison shell + monitor)
test_execute "Test mixte shell + monitor" \
"echo 'Setup' && monitor 'echo \"PsySH ready\";'" \
"PsySH ready" \
--context=mixed

# =============================================================================
# SECTION 4: TESTS AVEC FICHIERS
# =============================================================================

echo -e "${PURPLE}=== SECTION 4: Tests avec fichiers ===${NC}"

# CrÃ©er un fichier temporaire de test
echo 'monitor "$x = \"Hello World\"; echo $x;"' > /tmp/demo_test.txt

# Test depuis fichier
test_from_file "Test depuis fichier" "/tmp/demo_test.txt" "Hello World"

# Nettoyage
rm -f /tmp/demo_test.txt

# =============================================================================
# SECTION 5: TESTS D'ERREURS ET PATTERNS
# =============================================================================

echo -e "${PURPLE}=== SECTION 5: Tests d'erreurs ===${NC}"

# Test d'erreur avec pattern spÃ©cifique
test_error_pattern "Pattern d'erreur" \
'undefined_function();' \
"Call to undefined function"

# Test avec vÃ©rification d'erreur
test_execute "Test d'erreur attendue" \
'1/0;' \
"Division by zero" \
--context=monitor --output-check=error

# =============================================================================
# SECTION 6: TESTS DE SYNCHRONISATION
# =============================================================================

echo -e "${PURPLE}=== SECTION 6: Tests de synchronisation ===${NC}"

# Test de synchronisation bidirectionnelle
test_execute "Synchronisation variables" \
'$global_var = 123;' \
"123" \
--context=monitor --sync-test

# =============================================================================
# SECTION 7: TESTS COMBINÃ‰S ET COMPLEXES
# =============================================================================

echo -e "${PURPLE}=== SECTION 7: Tests combinÃ©s ===${NC}"

# Test combinÃ© multiple commandes
test_combined_commands "Combinaison complexe" \
'$x = 5;' \
'$y = 10;' \
'echo $x + $y;' \
"15"

# =============================================================================
# SECTION 8: TESTS DE PERFORMANCE ET LIMITES
# =============================================================================

echo -e "${PURPLE}=== SECTION 8: Tests de performance ===${NC}"

# Test avec timeout court
test_execute "Test avec timeout" \
'sleep(1); echo "done";' \
"done" \
--context=monitor --timeout=2

# Test avec debug activÃ©
test_execute "Test avec debug" \
'echo "debug test";' \
"debug test" \
--context=monitor --debug

# =============================================================================
# SECTION 9: DÃ‰MONSTRATION DES TYPES DE VÃ‰RIFICATION
# =============================================================================

echo -e "${PURPLE}=== SECTION 9: Types de vÃ©rification ===${NC}"

# VÃ©rification contains (par dÃ©faut)
test_execute "VÃ©rification contains" \
'echo "Hello World";' \
"World" \
--context=monitor --output-check=contains

# VÃ©rification exacte
test_execute "VÃ©rification exacte" \
'echo "42";' \
"42" \
--context=monitor --output-check=exact

# VÃ©rification regex
test_execute "VÃ©rification regex" \
'echo "test123";' \
"test[0-9]+" \
--context=monitor --output-check=regex

# VÃ©rification nÃ©gative
test_execute "VÃ©rification nÃ©gative" \
'echo "success";' \
"error" \
--context=monitor --output-check=not_contains

# =============================================================================
# SECTION 10: UTILISATION DES FONCTIONS DE CONVENANCE
# =============================================================================

echo -e "${PURPLE}=== SECTION 10: Fonctions de convenance ===${NC}"

# Utilisation des fonctions hÃ©ritÃ©es pour backward compatibility
test_monitor "Monitor simple legacy" 'echo "legacy test";' "legacy test"
test_monitor_multiline "Monitor multilignes legacy" '$x = "test"; echo $x;' "test"
test_monitor_expression "Monitor expression legacy" 'array_sum([1,2,3])' "6"
test_monitor_error "Monitor erreur legacy" 'undefined_var' "Undefined"
test_phpunit "PHPUnit legacy" 'assert "true"' "âœ…"

# =============================================================================
# RÃ‰SUMÃ‰ ET NETTOYAGE
# =============================================================================

echo ""
echo -e "${GREEN}=== DÃ‰MONSTRATION TERMINÃ‰E ===${NC}"
echo -e "${YELLOW}Cette dÃ©monstration a illustrÃ©:${NC}"
echo -e "${CYAN}â€¢ ${TEST_COUNT} tests exÃ©cutÃ©s avec diffÃ©rentes configurations${NC}"
echo -e "${CYAN}â€¢ Tous les contextes disponibles (monitor, phpunit, shell, mixed)${NC}"
echo -e "${CYAN}â€¢ Tous les types d'input et de vÃ©rification${NC}"
echo -e "${CYAN}â€¢ Les options avancÃ©es (retry, timeout, sync, debug)${NC}"
echo -e "${CYAN}â€¢ La compatibilitÃ© avec les anciennes fonctions${NC}"

# Afficher le rÃ©sumÃ© dÃ©taillÃ©
test_summary

# Nettoyage
cleanup_test_environment

# Statistiques finales
echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘                    STATISTIQUES FINALES                       â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}Tests rÃ©ussis: $PASS_COUNT${NC}"
echo -e "${RED}Tests Ã©chouÃ©s: $FAIL_COUNT${NC}"
echo -e "${BLUE}Taux de rÃ©ussite: $(( PASS_COUNT * 100 / TEST_COUNT ))%${NC}"

# Sortir avec le code appropriÃ©
if [[ $FAIL_COUNT -gt 0 ]]; then
    echo -e "${RED}âŒ Certains tests ont Ã©chouÃ©${NC}"
    exit 1
else
    echo -e "${GREEN}ğŸ‰ Tous les tests sont passÃ©s!${NC}"
    exit 0
fi
